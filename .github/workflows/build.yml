- name: Install Android cmdline-tools, accept licenses, install build-tools & NDK (robust)
  run: |
    set -euo pipefail

    ANDROID_HOME="$HOME/android-sdk"
    SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

    mkdir -p "$ANDROID_HOME/cmdline-tools"
    cd "$HOME"

    # download and extract commandline tools only if not already present
    if [ ! -x "$SDKMANAGER" ]; then
      TMP=$(mktemp -d)
      cd "$TMP"
      wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
      unzip -q tools.zip
      # find sdkmanager path inside the extracted tree and move to $ANDROID_HOME/cmdline-tools/latest
      FOUND=$(find . -type f -name sdkmanager -print -quit || true)
      if [ -z "$FOUND" ]; then
        echo "ERROR: sdkmanager not found inside downloaded archive"
        ls -R .
        exit 1
      fi
      # move the parent cmdline-tools dir to the final location
      PARENT_DIR=$(dirname "$(dirname "$FOUND")")
      mkdir -p "$ANDROID_HOME/cmdline-tools"
      rm -rf "$ANDROID_HOME/cmdline-tools/latest" || true
      mv "$PARENT_DIR" "$ANDROID_HOME/cmdline-tools/latest"
      cd "$HOME"
      rm -rf "$TMP"
    else
      echo "sdkmanager already present at $SDKMANAGER"
    fi

    # ensure PATH for this step (and we export later for subsequent steps)
    export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH"

    echo ">>> sdkmanager path: $(which sdkmanager 2>/dev/null || echo not-in-path)"
    echo ">>> sdkmanager file exists:" && ls -l "$SDKMANAGER" || true

    # Accept licenses (sdkmanager will exit when done; yes could get SIGPIPE â€” ignore nonzero with || true)
    yes | "$SDKMANAGER" --licenses >/dev/null 2>&1 || true

    # Install platform-tools, platform and build-tools + ndk (ignore non-zero but print output)
    "$SDKMANAGER" "platform-tools" "platforms;android-33" "build-tools;33.0.2" "build-tools;36.1.0" "ndk;25.2.9519653" || true

    # expose to following steps
    echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
    echo "ANDROID_SDK_ROOT=$ANDROID_HOME" >> $GITHUB_ENV
    echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
    echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
    echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH

    # Make Buildozer see our SDK location (symlink to where Buildozer expects)
    mkdir -p /home/runner/.buildozer/android/platform
    rm -rf /home/runner/.buildozer/android/platform/android-sdk || true
    ln -s "$ANDROID_HOME" /home/runner/.buildozer/android/platform/android-sdk

    # sanity checks
    echo "---- build-tools dir listing ----"
    ls -la "$ANDROID_HOME/build-tools" || true
    echo "---- check for aidl ----"
    ls -la "$ANDROID_HOME/build-tools"/*/aidl || true
